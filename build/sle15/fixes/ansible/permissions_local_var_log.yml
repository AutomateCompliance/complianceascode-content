# platform = multi_platform_sle
# reboot = false
# complexity = low
# strategy = configure
# disruption = low
- name: Find log files
  find:
    paths: /var/log/
    recurse: true
    patterns: '*'
  register: log_files
  tags:
    - CCE-85755-7
    - DISA-STIG-SLES-15-010340
    - NIST-800-53-SI-11(a)
    - NIST-800-53-SI-11(b)
    - NIST-800-53-SI-11.1(iii)
    - configure_strategy
    - low_complexity
    - low_disruption
    - medium_severity
    - no_reboot_needed
    - permissions_local_var_log

- name: Configure permission for /var/log/
  lineinfile:
    path: /etc/permissions.local
    regexp: ^{{ item.path }}\s+\w+\:\w+\d+\s*$
    line: "{{ item.path }}\t\t\t\t{{ item.pw_name }}:{{ item.gr_name }}\t640"
    state: present
  when: (item.mode | int) > 640
  with_items: '{{ log_files.files }}'
  register: update_permissions_local_logs_result
  tags:
    - CCE-85755-7
    - DISA-STIG-SLES-15-010340
    - NIST-800-53-SI-11(a)
    - NIST-800-53-SI-11(b)
    - NIST-800-53-SI-11.1(iii)
    - configure_strategy
    - low_complexity
    - low_disruption
    - medium_severity
    - no_reboot_needed
    - permissions_local_var_log

- name: Correct file permissions for /var/log
  shell: |
    chkstat --set --system
  when: update_permissions_local_logs_result.changed
  tags:
    - CCE-85755-7
    - DISA-STIG-SLES-15-010340
    - NIST-800-53-SI-11(a)
    - NIST-800-53-SI-11(b)
    - NIST-800-53-SI-11.1(iii)
    - configure_strategy
    - low_complexity
    - low_disruption
    - medium_severity
    - no_reboot_needed
    - permissions_local_var_log
