# platform = multi_platform_rhel,multi_platform_fedora,multi_platform_ol,multi_platform_rhv,multi_platform_sle
# reboot = true
# strategy = restrict
# complexity = medium
# disruption = low



- name: get current kernel parameters
  ansible.builtin.shell:
    cmd: '/usr/bin/grub2-editenv - list | grep "kernelopts="'
  register: kernelopts
  changed_when: False

- name: Update the bootloader menu
  command: /usr/bin/grub2-editenv - set "{{ item }} vsyscall=none"
  with_items: "{{ kernelopts.stdout_lines | select('match', '^kernelopts.*') | list }}"
  when:
    - kernelopts.stdout_lines is defined
    - kernelopts.stdout_lines | length > 0
    - kernelopts.stdout | regex_search('^kernelopts=(?:.*\s)?vsyscall=none(?:\s.*)?$', multiline=True) is none

